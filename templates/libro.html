<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Archivo - Bibliofy</title>
	<link rel="stylesheet" href="/static/styles.css"> 
</head>
<body>
	<p>{{data.nombre}}</p>
	<a href="{{data.pdf}}"><img src='{{data.img}}' width='100'></a>
	<p>{{data.autor}}
		{{data.descripcion}}
		{{data.categoria}}
	</p>
	<button id="eliminar" onclick="eliminar_libro(event)">Eliminar</button></p>
	<p id="puntuaciones">Puntuaciones:
		<script>
		function handle_response_puntuaciones(data){
			if (!data){
			alert('Error al cargar puntuaciones')
				window.location.href = `http://127.0.0.1:5000/`
			}else{
				
				var texto= data.puntuacion_promedio
				let puntuacion = document.getElementById('puntuaciones')
			
				let p = document.createElement('p')
				if (texto != "No tiene puntuaciones"){
					const estrellas=parseInt(texto)
					texto=""
					for (let i=0;i<estrellas;i++){
						texto+= "⭐"
					}
				}
				texto+=" (Valoraciones totales:"+data.cantidad_puntuaciones+")"
				p.innerText=texto
				puntuacion.append(texto)
			}
		}

		console.log("hola")
		fetch(`http://127.0.0.1:5000/puntuaciones/`+"{{data.id}}")
		.then((res)=>res.json())
		.then(handle_response_puntuaciones)
		.catch((error)=> console.log('ERROR',error))
		console.log("chau")
		</script>
	</p>
	
	<label for="estrellas">¡Valorá este libro! : </label>
	<form onsubmit="puntuar_libro(event)">
		<input
		type="range"
		name="estrellas"
		id="estrellas"
		min="1"
		max="5"
		step="1"
		value="3" />
		<output class="estrellas-output" for="estrellas"></output>
		<br>	
		<button type="submit">Enviar puntuacion</button>
	</form>
	
	<script>
		const price = document.querySelector("#estrellas");
		const output = document.querySelector(".estrellas-output");

		price.addEventListener("input", function () {
			output.textContent=""
			for (let i=0;i<price.value;i++){
				output.textContent+= "⭐"
					}
			});

	</script>

	<form onsubmit="agregar_comentario(event)">
		<p>Comentario: <br><input type="text" name="hola" required></p>
	
		<button type="submit">Enviar comentario</button>
	</form>
	<br> <button id="cargar_comentarios"onclick="get_comentarios(event)">Cargar comentarios</button>
	<img src="" alt="" id="imagen_libro">
	
    
	<ul id='lista_comentarios'>Lista de comentarios</ul>
	

	<script>

		function handle_response_agregar_comentario(data){
			if (!data){
				alert('Error: no se pudo agregar el comentario')
				window.location.href = `http://127.0.0.1:5000/`
			
			}else{
				window.location.href=`http://127.0.0.1:5000/catalogo/`+"{{data.id}}"
				let boton = document.getElementById("cargar_comentarios")
				boton.click()
			}
			
		}


		function agregar_comentario(event){
			event.preventDefault()
			const formData = new FormData(event.target)
			const id_libro = "{{data.id}}"
			const comentario = formData.get("hola")
		
			fetch(`http://127.0.0.1:5000/comentarios/`+id_libro,{
				method: "POST",
				headers: {
					"Content-Type":"application/json"
				},body:JSON.stringify({
					id_libro:id_libro,
					comentarios:comentario
					})	
			})
			.then((res)=>res.json())
			.then(handle_response_agregar_comentario)
			.catch((error)=> console.log("ERROR",error))
		}


		function handle_response_valorar_libro(data){
			if (!data){
				alert('Error: no se pudo puntuar el libro')
				window.location.href = `http://127.0.0.1:5000/`
			}
			window.location.href=`http://127.0.0.1:5000/catalogo/`+"{{data.id}}"
			
		}		
		

		function puntuar_libro(event){
			event.preventDefault()
			const formData = new FormData(event.target)
			const id_libro = "{{data.id}}"
			const puntuacion = formData.get("estrellas")
			fetch(`http://127.0.0.1:5000/puntuaciones/`+id_libro, {
				method: "POST",
				headers: {
					"Content-Type":"application/json"
				},
					body:JSON.stringify({
					id_libro:id_libro,
					puntuacion:puntuacion
					})												
				})
			
			.then((res)=>res.json())
			.then(handle_response_valorar_libro)
			.catch((error)=> console.log("ERROR",error))
		}

		function handle_response_delete(data){
			if (!data){
				alert('Error')
				window.location.href = `http://127.0.0.1:5000/`
			}
		}		

		function handle_response(data){
			if (!data){
				alert('Error')
				window.location.href = `http://127.0.0.1:5000/`
			}else{
				const ul = document.getElementById('lista_comentarios')
				ul.replaceChildren([])
				var comentarios_json = data
				for (var i = 0; i < data.comentarios.length; i++){
					/*console.log(data.comentarios[i].comentario)*/
					const texto = data.comentarios[i].comentario
					/*console.log(texto)*/
					const li = document.createElement('li')
					li.innerHTML=texto
					ul.appendChild(li)
				}
			}
		}
		function get_comentarios(event){
			event.preventDefault()
			
			fetch(`http://127.0.0.1:5000/comentarios/`+"{{data.id}}")
			.then((res)=>res.json())
			.then(handle_response)
			.catch((error)=> console.log('ERROR',error))
		}

		function eliminar_libro(event){
			event.preventDefault()
			var confirmacion = confirm('¿Está seguro de borrar el libro?')
			if (confirmacion){
				fetch(`http://127.0.0.1:5000/catalogo/`+"{{data.id}}", {
				method: "DELETE"												
				})
				.then((res)=>res.json())
				.then(handle_response_delete)
				.catch((error)=> console.log('ERROR',error))
			}
		}
	</script>
</body>
<footer>
	
</footer>
</html>